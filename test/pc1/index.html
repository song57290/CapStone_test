<!doctype html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>PC1 - ì‹¤ì œ ì¡°ì´ìŠ¤í‹± ë°ì´í„° ì „ì†¡ ë° ì˜ìƒ ìˆ˜ì‹ </title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.0/simplepeer.min.js"></script>
<script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
</head>

<body class="bg-gray-100">
<header class="flex items-center justify-between p-4 bg-blue-800 text-white">
  <div class="flex items-center gap-4">
    <img src="https://blog.kakaocdn.net/dn/71hSN/btsJTBBLxY4/JjQxPDPxp1BZhDPm9u0bEK/img.gif" alt="ë¡œê³  ì´ë¯¸ì§€" class="h-14 w-auto rounded-full">
    <h1 class="text-xl font-bold whitespace-nowrap">PC1 - ì‹¤ì œ ì¡°ì´ìŠ¤í‹± ë°ì´í„° ì „ì†¡ ë° ì˜ìƒ ìˆ˜ì‹ </h1>
  </div>
  <div class="flex gap-2">
    <button id="reconnectButton" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">ì¬ì—°ê²°</button>
    <button id="disconnectButton" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">ì—°ê²° ì¢…ë£Œ</button>
  </div>
</header>

<main class="flex flex-col gap-4 p-4">
  <section class="flex flex-col gap-2 rounded bg-white p-4 shadow">
    <div id="status" class="text-lg font-semibold text-yellow-600">ì—°ê²° ëŒ€ê¸°ì¤‘...</div>
    <div id="outgoingData" class="text-gray-700 text-center">ì „ì†¡ ë°ì´í„° ì—†ìŒ</div>
  </section>

  <!-- ê°€ë¡œí˜•ìœ¼ë¡œ ë¶„ë¦¬: ì™¼ìª½ - ì˜ìƒ / ì˜¤ë¥¸ìª½ - ëŒ€í™”ì°½ -->
  <div class="flex gap-4">
    <!-- ì™¼ìª½: ì˜ìƒ -->
    <section class="flex-1 flex flex-col gap-4">
      <video id="remoteVideo" autoplay playsinline muted class="h-auto w-full rounded bg-black shadow"></video>
      <div class="flex flex-wrap items-center gap-2 rounded bg-white p-2 shadow">
        <label for="videoWidth" class="text-sm">Width:</label>
        <input type="number" id="videoWidth" value="1920" class="w-24 rounded border p-1 text-sm" />
        <label for="videoHeight" class="text-sm">Height:</label>
        <input type="number" id="videoHeight" value="1080" class="w-24 rounded border p-1 text-sm" />
        <button id="updateSize" class="rounded bg-blue-600 px-2 py-1 text-sm text-white hover:bg-blue-700">ì‚¬ì´ì¦ˆ ì ìš©</button>
      </div>
    </section>

    <!-- ì˜¤ë¥¸ìª½: ëŒ€í™”ì°½ ë° íŒŒì¼ ì „ì†¡ -->
    <section class="w-1/4 flex flex-col gap-2 bg-white p-4 shadow rounded">
      <h2 class="text-lg font-semibold">ëŒ€í™”ì°½ / íŒŒì¼ ì „ì†¡</h2>
      <div id="chatBox" class="flex-1 h-80 overflow-y-scroll bg-gray-50 p-2 mb-2"></div>
      <input type="file" id="fileInput" class="mb-2">
      <div class="flex gap-2">
        <input type="text" id="messageInput" class="flex-1 border p-1 rounded" placeholder="ë©”ì‹œì§€ ì…ë ¥...">
        <button id="sendButton" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded">ì „ì†¡</button>
      </div>
    </section>
  </div>

  <!-- â­ï¸ ë¡œê·¸ ì œì–´ í™•ì¥ ë²„íŠ¼ ì˜ì—­ -->
  <section class="flex gap-2 p-4 bg-white shadow rounded items-center">
    <button id="startLogButton" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">ë¡œê·¸ ì‹œì‘</button>
    <button id="stopLogButton" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">ë¡œê·¸ ì¢…ë£Œ</button>
    <button id="resetLogButton" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">ì´ˆê¸°í™”</button>
    <button id="pauseLogButton" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded">ì •ì§€</button>
    <label class="ml-4 font-semibold text-sm">ë°˜ë³µ íšŸìˆ˜:</label>
    <input type="number" id="repeatCountInput" class="w-20 border rounded p-1 text-sm" min="1" value="3">

    <!-- â­ï¸ ë°˜ë³µ ìƒíƒœ í‘œì‹œ -->
    <span id="repeatStatus" class="ml-4 text-sm text-blue-700 font-semibold"></span>
  </section>
</main>

<script>
const signalingServer = 'https://my-signaling-server-uo91.onrender.com';
const socket = io(signalingServer, { transports: ['websocket'] });
let peer = null;
let isReconnecting = false;

function updateStatus(text, colorClass) {
  const statusElem = document.getElementById('status');
  statusElem.innerText = text;
  statusElem.classList.remove('text-yellow-600', 'text-green-600', 'text-red-600');
  statusElem.classList.add(colorClass);
}

function initializePeer() {
  if (peer && !peer.destroyed) peer.destroy();

  peer = new SimplePeer({
    initiator: true,
    trickle: false,
    config: {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'turn:your.external.ip:3478', username: 'user', credential: 'pass' }
      ]
    }
  });

  peer.on('signal', data => socket.emit('signal', data));
  peer.on('connect', () => {
    isReconnecting = false;
    updateStatus('PC2ì™€ ì—°ê²°ë¨', 'text-green-600');
  });
  peer.on('close', () => {
    if (isReconnecting) {
      console.log("PC1: ì¬ì ‘ì† ì¤‘...");
      return;
    }
    updateStatus('ì—°ê²° ëŠì–´ì§', 'text-red-600');
  });
  peer.on('track', (track, stream) => {
    document.getElementById('remoteVideo').srcObject = stream;
  });
}

socket.on('signal', data => {
  if (peer) peer.signal(data);
});

// â­ï¸ ë¡œê·¸ ì œì–´ìš© ë³€ìˆ˜
let isLogging = false;
let loggedData = [];
let replayInterval = null;
let currentRepeat = 0;
let maxRepeat = 3; // ê¸°ë³¸ ë°˜ë³µ íšŸìˆ˜
const MAX_LOG_FRAME = 300; // â­ ìµœëŒ€ 300 frameë§Œ ì €ì¥

function updateRepeatStatus() {
  const status = document.getElementById("repeatStatus");
  if (currentRepeat === 0) {
    status.textContent = "";
  } else if (currentRepeat <= maxRepeat) {
    status.textContent = `ğŸ” ë°˜ë³µ ${currentRepeat} / ${maxRepeat}`;
  } else {
    status.textContent = "âœ… ë°˜ë³µ ì™„ë£Œ";
  }
}

document.getElementById('startLogButton').addEventListener('click', () => {
  isLogging = true;
  loggedData = [];
  clearInterval(replayInterval);
  currentRepeat = 0;
  updateRepeatStatus();
  document.getElementById('startLogButton').textContent = "ë¡œê·¸ ì¸¡ì • ì¤‘...";
  console.log('ë¡œê·¸ ì‹œì‘');
});

document.getElementById('stopLogButton').addEventListener('click', () => {
  isLogging = false;
  clearInterval(replayInterval);
  maxRepeat = parseInt(document.getElementById('repeatCountInput').value) || 1;

  // â­ ë¬´ì¡°ê±´ ì›ë³µ
  document.getElementById('startLogButton').textContent = "ë¡œê·¸ ì‹œì‘";

  if (loggedData.length > 0 && peer && peer.connected) {
    console.log(`ë¡œê·¸ ì¢…ë£Œ â†’ ë°˜ë³µ ì¬ìƒ ${maxRepeat}íšŒ ì‹œì‘`);
    let index = 0;
    currentRepeat = 1;
    updateRepeatStatus();
    replayInterval = setInterval(() => {
      if (!peer || !peer.connected) return;
      peer.send(JSON.stringify(loggedData[index]));
      console.log("ğŸ”¸ ë°˜ë³µ ì „ì†¡ ì¤‘:", loggedData[index]); // â­ PC1 ì¸¡ í™•ì¸ìš©
      index++;

      if (index >= loggedData.length) {
        index = 0;
        currentRepeat++;
        updateRepeatStatus();
        if (currentRepeat > maxRepeat) {
          clearInterval(replayInterval);
          updateRepeatStatus();
          console.log('ğŸ‰ ë°˜ë³µ ì™„ë£Œ');
        }
      }
    }, 100);
  }
});

document.getElementById('pauseLogButton').addEventListener('click', () => {
  clearInterval(replayInterval);
  updateRepeatStatus();
  document.getElementById('startLogButton').textContent = "ë¡œê·¸ ì‹œì‘";
  console.log('â¸ ë°˜ë³µ ì¤‘ë‹¨ë¨');
});

document.getElementById('resetLogButton').addEventListener('click', () => {
  isLogging = false;
  loggedData = [];
  currentRepeat = 0;
  clearInterval(replayInterval);
  updateRepeatStatus();
  document.getElementById('startLogButton').textContent = "ë¡œê·¸ ì‹œì‘";
  console.log('ğŸ§¹ ë¡œê·¸ ì´ˆê¸°í™” ì™„ë£Œ');
});

function updateGamepad() {
  const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
  if (gamepads[0]) {
    const gp = gamepads[0];
    const data = {
      axes: gp.axes.map(v => +v.toFixed(2)),
      buttons: gp.buttons.map(b => b.pressed ? 1 : 0)
    };

    document.getElementById('outgoingData').innerHTML = `
      <div class="flex flex-wrap justify-center gap-4 text-lg font-bold">
        |<div class="flex items-center gap-1">Xì¶•: <span class="text-black w-10 text-center">${data.axes[0]}</span></div>|
        <div class="flex items-center gap-1">Yì¶•: <span class="text-black w-10 text-center">${-data.axes[1]}</span></div>|
        <div class="flex items-center gap-1">Zì¶•: <span class="text-black w-10 text-center">${-data.axes[3] || 0}</span></div>|
        <div class="flex items-center gap-1">Aë²„íŠ¼: <span class="text-black w-10 text-center">${data.buttons[4]}</span></div>|
        <div class="flex items-center gap-1">Bë²„íŠ¼: <span class="text-black w-10 text-center">${data.buttons[5]}</span></div>|
      </div>`;

    if (peer && peer.connected) {
      peer.send(JSON.stringify(data));
    }

    if (isLogging && loggedData.length < MAX_LOG_FRAME) {
      loggedData.push(data);
    }
  }
  requestAnimationFrame(updateGamepad);
}
window.addEventListener("gamepadconnected", () => updateGamepad());

/* (ìƒëµ) appendMessage, fileInput, sendButton, reconnectButton, disconnectButton, updateSize ë™ì¼ â€” ì´ì „ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ */

initializePeer();
</script>
</body>
</html>
