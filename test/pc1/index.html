<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>PC1 - ì‹¤ì œ ì¡°ì´ìŠ¤í‹± ë°ì´í„° ì „ì†¡ ë° ì˜ìƒ ìˆ˜ì‹ </title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.0/simplepeer.min.js"></script>
  <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
</head>

<body class="bg-gray-100">
<header class="flex items-center justify-between p-4 bg-blue-800 text-white">
  <div class="flex items-center gap-4">
    <img src="https://blog.kakaocdn.net/dn/71hSN/btsJTBBLxY4/JjQxPDPxp1BZhDPm9u0bEK/img.gif" alt="ë¡œê³  ì´ë¯¸ì§€" class="h-14 w-auto rounded-full">
    <h1 class="text-xl font-bold whitespace-nowrap">PC1 - ì‹¤ì œ ì¡°ì´ìŠ¤í‹± ë°ì´í„° ì „ì†¡ ë° ì˜ìƒ ìˆ˜ì‹ </h1>
  </div>
  <div class="flex gap-2">
    <button id="reconnectButton" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">ì¬ì—°ê²°</button>
    <button id="disconnectButton" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">ì—°ê²° ì¢…ë£Œ</button>
  </div>
</header>

<main class="flex flex-col gap-4 p-4">
  <section class="flex flex-col gap-2 rounded bg-white p-4 shadow">
    <div id="status" class="text-lg font-semibold text-yellow-600">ì—°ê²° ëŒ€ê¸°ì¤‘...</div>
    <div id="outgoingData" class="text-gray-700 text-center">ì „ì†¡ ë°ì´í„° ì—†ìŒ</div>
  </section>

  <div class="flex gap-4">
    <section class="flex-1 flex flex-col gap-4">
      <video id="remoteVideo" autoplay playsinline muted class="h-auto w-full rounded bg-black shadow"></video>
      <div class="flex flex-wrap items-center gap-2 rounded bg-white p-2 shadow">
        <label for="videoWidth" class="text-sm">Width:</label>
        <input type="number" id="videoWidth" value="1920" class="w-24 rounded border p-1 text-sm" />
        <label for="videoHeight" class="text-sm">Height:</label>
        <input type="number" id="videoHeight" value="1080" class="w-24 rounded border p-1 text-sm" />
        <button id="updateSize" class="rounded bg-blue-600 px-2 py-1 text-sm text-white hover:bg-blue-700">ì‚¬ì´ì¦ˆ ì ìš©</button>
      </div>
    </section>

    <section class="w-1/4 flex flex-col gap-2 bg-white p-4 shadow rounded">
      <h2 class="text-lg font-semibold">ëŒ€í™”ì°½ / íŒŒì¼ ì „ì†¡</h2>
      <div id="chatBox" class="flex-1 h-80 overflow-y-scroll bg-gray-50 p-2 mb-2"></div>
      <input type="file" id="fileInput" class="mb-2">
      <div class="flex gap-2">
        <input type="text" id="messageInput" class="flex-1 border p-1 rounded" placeholder="ë©”ì‹œì§€ ì…ë ¥...">
        <button id="sendButton" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded">ì „ì†¡</button>
      </div>
    </section>
  </div>

  <section class="flex gap-2 p-4 bg-white shadow rounded items-center">
    <button id="startLogButton" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">ë¡œê·¸ ì‹œì‘</button>
    <button id="stopLogButton" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">ë¡œê·¸ ì¢…ë£Œ</button>
    <button id="resetLogButton" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">ì´ˆê¸°í™”</button>

    <div class="flex gap-2 ml-auto">
        <button id="resumeLogButton" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">ì¬ìƒ ì‹œì‘</button>
        <button id="pauseLogButton" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded">ì¬ìƒ ì •ì§€</button>
    </div>
  </section>
</main>

<script>
  const signalingServer = 'https://my-signaling-server-uo91.onrender.com';
  const socket = io(signalingServer, { transports: ['websocket'] });
  let peer = null;
  let isReconnecting = false;
  let isLogging = false;
  let loggedData = [];
  let isReplaying = false;
  let replayIndex = 0;
  let replayTimeout = null;

  function updateStatus(text, colorClass) {
    const statusElem = document.getElementById('status');
    statusElem.innerText = text;
    statusElem.classList.remove('text-yellow-600', 'text-green-600', 'text-red-600');
    statusElem.classList.add(colorClass);
  }

  function initializePeer() {
    if (peer && !peer.destroyed) peer.destroy();

    peer = new SimplePeer({
      initiator: true,
      trickle: false,
      config: {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'turn:your.external.ip:3478', username: 'user', credential: 'pass' }
        ]
      }
    });

    peer.on('signal', data => socket.emit('signal', data));
    peer.on('connect', () => {
      isReconnecting = false;
      updateStatus('PC2ì™€ ì—°ê²°ë¨', 'text-green-600');
      console.log('ğŸ”„ peer connected');
      isLogging = false;
      document.getElementById('startLogButton').textContent = "ë¡œê·¸ ì‹œì‘";
    });

    peer.on('close', () => {
      if (isReconnecting) {
        console.log("PC1: ì¬ì ‘ì† ì¤‘...");
        return;
      }
      updateStatus('ì—°ê²° ëŠì–´ì§', 'text-red-600');
    });

    peer.on('track', (track, stream) => {
      document.getElementById('remoteVideo').srcObject = stream;
    });
  }

  socket.on('signal', data => {
    if (peer) peer.signal(data);
  });

  document.getElementById('startLogButton').addEventListener('click', () => {
    isLogging = true;
    loggedData = [];
    isReplaying = false;
    clearTimeout(replayTimeout);
    document.getElementById('startLogButton').textContent = "ë¡œê·¸ ì¸¡ì • ì¤‘...";
    updateStatus('ğŸ“ ë°˜ë³µ ì‘ì—… ì¸¡ì • ì¤‘...', 'text-green-600');
    console.log('ë¡œê·¸ ì‹œì‘');
  });

  document.getElementById('stopLogButton').addEventListener('click', () => {
    isLogging = false;
    isReplaying = true;
    replayIndex = 0;
    clearTimeout(replayTimeout);
    document.getElementById('startLogButton').textContent = "ë¡œê·¸ ì‹œì‘";
    updateStatus('ğŸ” ë°˜ë³µ ì‘ì—… ì¤‘... | ì¡°ì´ìŠ¤í‹± ì…ë ¥ ì¤‘ì§€', 'text-green-600');
    console.log(`ë¡œê·¸ ì¢…ë£Œ â†’ ë¬´í•œ ë°˜ë³µ ì¬ìƒ ì‹œì‘`);
    startReplay();
  });

  document.getElementById('pauseLogButton').addEventListener('click', () => {
    isReplaying = false;
    clearTimeout(replayTimeout);
    document.getElementById('startLogButton').textContent = "ë¡œê·¸ ì‹œì‘";
    updateStatus('â¸ ë°˜ë³µ ì‘ì—… ì¤‘ë‹¨ë¨!', 'text-yellow-600');
    console.log('â¸ ë°˜ë³µ ì¤‘ë‹¨ë¨');
  });

  document.getElementById('resetLogButton').addEventListener('click', () => {
    isLogging = false;
    loggedData = [];
    isReplaying = false;
    clearTimeout(replayTimeout);
    document.getElementById('startLogButton').textContent = "ë¡œê·¸ ì‹œì‘";
    updateStatus('ğŸ§¹ ì´ˆê¸°í™” ì™„ë£Œ!', 'text-red-600');
    console.log('ğŸ§¹ ë¡œê·¸ ì´ˆê¸°í™” ì™„ë£Œ');
  });

  document.getElementById('resumeLogButton').addEventListener('click', () => {
    if (loggedData.length > 0 && peer && peer.connected && !isReplaying) {
      console.log(`â–¶ï¸ ë°˜ë³µ ì¬ìƒ ì¬ì‹œì‘`);
      updateStatus('â–¶ï¸ ë°˜ë³µ ì‘ì—… ì¤‘... | ì¡°ì´ìŠ¤í‹± ì…ë ¥ ì¤‘ì§€', 'text-green-600');
      isReplaying = true;
      replayIndex = 0;
      startReplay();
    } else {
      console.log('âš ï¸ ì¬ìƒí•  ë¡œê·¸ê°€ ì—†ê±°ë‚˜ ì´ë¯¸ ì¬ìƒ ì¤‘ì…ë‹ˆë‹¤.');
      updateStatus('ğŸš« ì¬ìƒí•  ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.', 'text-red-600');
    }
  });

  function startReplay() {
    if (!peer || !peer.connected || !isReplaying) return;

    const currentData = loggedData[replayIndex];
    peer.send(JSON.stringify({
      axes: currentData.axes,
      buttons: currentData.buttons
    }));

    const x = currentData.axes[0];
    const y = currentData.axes[1];
    const z = currentData.axes[3] || 0;
    const A = currentData.buttons[4] || 0;
    const B = currentData.buttons[5] || 0;
    console.log(`â–¶ï¸ ë°˜ë³µ ì „ì†¡ ì¤‘: X=${x}, Y=${y}, Z=${z}, LB=${A}, RB=${B}`);

    // ğŸŸ¢ ì¶”ê°€ : í™”ë©´ì—ë„ ë°˜ë³µì¤‘ì¸ ê°’ í‘œì‹œí•˜ê¸°
    document.getElementById('outgoingData').innerHTML = `
      <div class="flex flex-wrap justify-center gap-4 text-lg font-bold">
      |<div class="flex items-center gap-1">Xì¶•: <span class="text-black w-10 text-center">${x}</span></div>|
      <div class="flex items-center gap-1">Yì¶•: <span class="text-black w-10 text-center">${-y}</span></div>|
      <div class="flex items-center gap-1">Zì¶•: <span class="text-black w-10 text-center">${-z}</span></div>|
      <div class="flex items-center gap-1">LB: <span class="text-black w-10 text-center">${A}</span></div>|
      <div class="flex items-center gap-1">RB: <span class="text-black w-10 text-center">${B}</span></div>|
    </div>`;

    const currentTimestamp = currentData.timestamp;
    replayIndex++;
    if (replayIndex >= loggedData.length) replayIndex = 0;
    const nextTimestamp = loggedData[replayIndex].timestamp;
    let delay = nextTimestamp - currentTimestamp;
    delay = Math.max(16, delay);

    replayTimeout = setTimeout(startReplay, delay);
  }


  function updateGamepad() {
    const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
    if (gamepads[0]) {
      const gp = gamepads[0];
      const data = {
      axes: gp.axes.map(v => +v.toFixed(2)),
      buttons: gp.buttons.map(b => b.pressed ? 1 : 0),
      timestamp: Date.now()
      };

      if (!isReplaying) {
      document.getElementById('outgoingData').innerHTML = `
        <div class="flex flex-wrap justify-center gap-4 text-lg font-bold">
        |<div class="flex items-center gap-1">Xì¶•: <span class="text-black w-10 text-center">${data.axes[0]}</span></div>|
        <div class="flex items-center gap-1">Yì¶•: <span class="text-black w-10 text-center">${-data.axes[1]}</span></div>|
        <div class="flex items-center gap-1">Zì¶•: <span class="text-black w-10 text-center">${-data.axes[3] || 0}</span></div>|
        <div class="flex items-center gap-1">LB: <span class="text-black w-10 text-center">${data.buttons[4]}</span></div>|
        <div class="flex items-center gap-1">RB: <span class="text-black w-10 text-center">${data.buttons[5]}</span></div>|
        </div>`;
      }

      if (peer && peer.connected && !isReplaying) {
        peer.send(JSON.stringify(data));

        const x = data.axes[0];
        const y = data.axes[1];
        const z = data.axes[3] || 0;
        const A = data.buttons[4] || 0;
        const B = data.buttons[5] || 0;
        console.log(`ğŸ“¤ X: ${x}, Y: ${y}, Z: ${z}, LB: ${A}, RB: ${B}`);
      }

      if (isLogging && loggedData.length < 300) {
        loggedData.push(data);
      }
    }
    requestAnimationFrame(updateGamepad);
  }

  window.addEventListener("gamepadconnected", (e) => {
    console.log("ğŸ® ì¡°ì´ìŠ¤í‹± ì—°ê²°ë¨:", e.gamepad);
    updateGamepad();
  });

  document.getElementById('disconnectButton').addEventListener('click', () => {
    socket.emit('disconnectSignal', { from: 'PC1' });
    if (peer && !peer.destroyed) peer.destroy();
    updateStatus('ì—°ê²° ëŠì–´ì§', 'text-red-600');
  });

  document.getElementById('reconnectButton').addEventListener('click', () => {
    isReconnecting = true;
    updateStatus('ì—°ê²° ëŒ€ê¸°ì¤‘...', 'text-yellow-600');
    clearTimeout(replayTimeout);
    loggedData = [];
    isReplaying = false;
    document.getElementById('startLogButton').textContent = "ë¡œê·¸ ì‹œì‘";
    initializePeer();
    socket.emit('reconnectRequest', { from: 'PC1' });
  });

  document.getElementById('updateSize').addEventListener('click', () => {
    const w = document.getElementById('videoWidth').value;
    const h = document.getElementById('videoHeight').value;
    const v = document.getElementById('remoteVideo');
    v.style.width = w + 'px';
    v.style.height = h + 'px';
  });

  initializePeer();

  // âœ… 2. ì´ ì•ˆì—ì„œëŠ” ì œê±°í•´ì¤˜
  document.getElementById('sendButton').addEventListener('click', () => {
    const input = document.getElementById('messageInput');
    const msg = input.value.trim();
    if (!msg) return;

    if (peer && peer.connected) {
      peer.send(JSON.stringify({ type: 'chat', message: msg }));
      const chatBox = document.getElementById('chatBox');
      chatBox.innerHTML += `<div class="text-right text-blue-600">ğŸ“¤ ë‚˜: ${msg}</div>`;
      chatBox.scrollTop = chatBox.scrollHeight;
      input.value = '';
    } else {
      alert("ìƒëŒ€ë°©ê³¼ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    }
  });


  document.getElementById('messageInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
      document.getElementById('sendButton').click();
    }
  });

  document.getElementById('fileInput').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;

  // ğŸ›‘ íŒŒì¼ í¬ê¸° ì œí•œ: 100KB ì´ˆê³¼ ì‹œ ê²½ê³ 
  if (file.size > 100 * 1024) {
    alert("ì „ì†¡ ë¶ˆê°€! 100KB ì´í•˜ì˜ íŒŒì¼ë§Œ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    return;
  }

  const reader = new FileReader();
  reader.onload = () => {
    if (peer && peer.connected) {
      peer.send(JSON.stringify({
        type: 'file',
        filename: file.name,
        data: reader.result
      }));

      const chatBox = document.getElementById('chatBox');
      chatBox.innerHTML += `<div class="text-right text-blue-600">ğŸ“¤ íŒŒì¼ ì „ì†¡: ${file.name}</div>`;
      chatBox.scrollTop = chatBox.scrollHeight;
    }
  };
  reader.readAsDataURL(file); // base64 ì¸ì½”ë”©
});


  </script>
  </body>
</html>
