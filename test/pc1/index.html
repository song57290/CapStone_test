<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>PC1 - ì‹¤ì œ ì¡°ì´ìŠ¤í‹± ë°ì´í„° ì „ì†¡ ë° ì˜ìƒ ìˆ˜ì‹ </title>
  <script src="https://cdn.tailwindcss.com"></script> <!-- Tailwind CSS í™œìš©í•˜ì—¬ UI ìŠ¤íƒ€ì¼ë§ -->
  <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.0/simplepeer.min.js"></script>
  <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
</head>

<body class="bg-gray-100">
<header class="flex items-center justify-between p-4 bg-blue-800 text-white">
  <div class="flex items-center gap-4">
    <img src="https://blog.kakaocdn.net/dn/71hSN/btsJTBBLxY4/JjQxPDPxp1BZhDPm9u0bEK/img.gif" alt="ë¡œê³  ì´ë¯¸ì§€" class="h-14 w-auto rounded-full">
    <h1 class="text-xl font-bold whitespace-nowrap">PC1 - ì‹¤ì œ ì¡°ì´ìŠ¤í‹± ë°ì´í„° ì „ì†¡ ë° ì˜ìƒ ìˆ˜ì‹ </h1>
  </div>
  <div class="flex gap-2">
    <button id="reconnectButton" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">ì¬ì—°ê²°</button>
    <button id="disconnectButton" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">ì—°ê²° ì¢…ë£Œ</button>
  </div>
</header>

<main class="flex flex-col gap-4 p-4">
  <section class="flex flex-col gap-2 rounded bg-white p-4 shadow">
    <div id="status" class="text-lg font-semibold text-yellow-600">ì—°ê²° ëŒ€ê¸°ì¤‘...</div>
    <div id="outgoingData" class="text-gray-700 text-center">ì „ì†¡ ë°ì´í„° ì—†ìŒ</div>
  </section>

  <div class="flex gap-4">
    <section class="flex-1 flex flex-col gap-4">
      <video id="remoteVideo" autoplay playsinline muted class="h-auto w-full rounded bg-black shadow"></video>
      <button id="fullscreenButton" class="bg-gray-100 hover:bg-gray-400 text-black px-4 py-2 rounded">ì „ì²´í™”ë©´</button>
      <div class="flex flex-wrap items-center gap-2 rounded bg-white p-2 shadow">
        <label for="videoWidth" class="text-sm">Width:</label>
        <input type="number" id="videoWidth" value="1920" class="w-24 rounded border p-1 text-sm" />
        <label for="videoHeight" class="text-sm">Height:</label>
        <input type="number" id="videoHeight" value="1080" class="w-24 rounded border p-1 text-sm" />
        <button id="updateSize" class="rounded bg-blue-600 px-2 py-1 text-sm text-white hover:bg-blue-700">ì‚¬ì´ì¦ˆ ì ìš©</button>
      </div>
    </section>

    <section class="w-1/4 flex flex-col gap-2 bg-white p-4 shadow rounded">
      <h2 class="text-lg font-semibold">ëŒ€í™”ì°½ / íŒŒì¼ ì „ì†¡</h2>
      <div id="chatBox" class="flex-1 h-80 overflow-y-scroll bg-gray-50 p-2 mb-2"></div>
      <input type="file" id="fileInput" class="mb-2">
      <div class="flex gap-2">
        <input type="text" id="messageInput" class="flex-1 border p-1 rounded" placeholder="ë©”ì‹œì§€ ì…ë ¥...">
        <button id="sendButton" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-1 rounded">ì „ì†¡</button>
        <button id="clearChatButton" class="bg-red-500 hover:bg-red-600 text-white px-6 py-1 rounded">ëŒ€í™”ì°½ ì´ˆê¸°í™”</button>
      </div>      
    </section>
  </div>

  <section class="flex gap-2 p-4 bg-white shadow rounded items-center">
    <button id="startLogButton" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">ë°˜ë³µ ì‹œì‘</button>
    <button id="stopLogButton" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">ë°˜ë³µ ì¢…ë£Œ</button>
    <button id="resetLogButton" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">ì´ˆê¸°í™”</button>
    <div class="flex gap-2 ml-auto">
      <button id="resumeLogButton" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">ì¬ìƒ ì‹œì‘</button>
      <button id="pauseLogButton" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded">ì¬ìƒ ì •ì§€</button>
    </div>
  </section>
</main>

<script>
  const signalingServer = 'https://my-signaling-server-uo91.onrender.com';
  const socket = io(signalingServer, { transports: ['websocket'] });
  let peer = null;
  let isReconnecting = false;
  let isLogging = false;
  let loggedData = [];
  let isReplaying = false;
  let replayIndex = 0;
  let replayTimeout = null;
  let isLooping = false;
  let isForward = true;

  function updateStatus(text, colorClass) {
    const statusElem = document.getElementById('status');
    statusElem.innerText = text;
    statusElem.classList.remove('text-yellow-600', 'text-green-600', 'text-red-600');
    statusElem.classList.add(colorClass);
  }

  function updateDataUI(data) {
    const x = data.axes[0] || 0;
    const y = data.axes[1] || 0;
    const z = data.axes[3] || 0;
    const A = data.buttons[4] || 0;
    const B = data.buttons[5] || 0;
    document.getElementById('outgoingData').innerHTML = `
      <div class="flex flex-wrap justify-center gap-4 text-lg font-bold">
        |<div class="flex items-center gap-1">Xì¶•: <span class="text-black w-10 text-center">${x.toFixed(2)}</span></div>|
        <div class="flex items-center gap-1">Yì¶•: <span class="text-black w-10 text-center">${(-y).toFixed(2)}</span></div>|
        <div class="flex items-center gap-1">Zì¶•: <span class="text-black w-10 text-center">${(-z).toFixed(2)}</span></div>|
        <div class="flex items-center gap-1">LB: <span class="text-black w-10 text-center">${A}</span></div>|
        <div class="flex items-center gap-1">RB: <span class="text-black w-10 text-center">${B}</span></div>|
      </div>`;
  }

  function initializePeer() {
    if (peer && !peer.destroyed) peer.destroy();
    peer = new SimplePeer({
      initiator: true,
      trickle: false,
      config: {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'turn:your.external.ip:3478', username: 'user', credential: 'pass' }
        ]
      }
    });

    peer.on('signal', data => socket.emit('signal', data));
    peer.on('connect', () => {
      isReconnecting = false;
      updateStatus('PC2ì™€ ì—°ê²°ë¨', 'text-green-600');
      console.log('ğŸ”„ peer connected');
      isLogging = false;
      document.getElementById('startLogButton').textContent = "ë¡œê·¸ ì‹œì‘";
    });

    peer.on('close', () => {
      if (isReconnecting) {
        console.log("PC1: ì¬ì ‘ì† ì¤‘...");
        return;
      }
      updateStatus('ì—°ê²° ëŠì–´ì§', 'text-red-600');
    });

    peer.on('track', (track, stream) => {
      document.getElementById('remoteVideo').srcObject = stream;
    });

    peer.on('data', data => {
      const parsed = JSON.parse(data);
      if (parsed.type === 'chat') {
        const chatBox = document.getElementById('chatBox');
        chatBox.innerHTML += `<div class="text-left text-green-600">ğŸ“¥ PC2: ${parsed.message}</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
      } else if (parsed.type === 'file') {
        const chatBox = document.getElementById('chatBox');
        chatBox.innerHTML += `<div class="text-left text-green-600">ğŸ“¥ PC2 íŒŒì¼: ${parsed.filename}</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    });
  }

  socket.on('signal', data => {
    if (peer) peer.signal(data);
  });

  document.getElementById('startLogButton').addEventListener('click', () => {
    isLogging = true;
    loggedData = [];
    isReplaying = false;
    clearTimeout(replayTimeout);
    document.getElementById('startLogButton').textContent = "ë¡œê·¸ ì¸¡ì • ì¤‘...";
    updateStatus('ğŸ“ ë°˜ë³µ ì‘ì—… ì¸¡ì • ì¤‘...', 'text-green-600');
    console.log('ë¡œê·¸ ì‹œì‘');
  });

  document.getElementById('stopLogButton').addEventListener('click', () => {
    isLogging = false;
    isReplaying = true;
    isLooping = true;
    replayIndex = loggedData.length - 1; // ì—­ë°©í–¥ ì‹œì‘ì„ ìœ„í•´ ë§ˆì§€ë§‰ ì¸ë±ìŠ¤ë¡œ ì„¤ì •
    isForward = false; // ìµœì´ˆ ì¬ìƒì„ ì—­ë°©í–¥ìœ¼ë¡œ ì„¤ì •
    clearTimeout(replayTimeout);
    document.getElementById('startLogButton').textContent = "ë¡œê·¸ ì‹œì‘";
    updateStatus('ğŸ” ì—­ë°©í–¥/ìˆœë°©í–¥ ë°˜ë³µ ì¤‘... | ì¡°ì´ìŠ¤í‹± ì…ë ¥ ì¤‘ì§€', 'text-green-600');
    console.log('ë¡œê·¸ ì¢…ë£Œ â†’ ì—­ë°©í–¥ìœ¼ë¡œ ì‹œì‘, ì´í›„ ìˆœë°©í–¥/ì—­ë°©í–¥ ë¬´í•œ ë°˜ë³µ');
    loopReplay();
  });

  document.getElementById('pauseLogButton').addEventListener('click', () => {
    isReplaying = false;
    isLooping = false;
    clearTimeout(replayTimeout);
    document.getElementById('startLogButton').textContent = "ë¡œê·¸ ì‹œì‘";
    updateStatus('â¸ ë°˜ë³µ ì‘ì—… ì¤‘ë‹¨ë¨!', 'text-yellow-600');
    console.log('ì¬ìƒ ì •ì§€');
  });

  document.getElementById('resumeLogButton').addEventListener('click', () => {
    if (loggedData.length > 0 && peer && peer.connected && !isReplaying) {
      isReplaying = true;
      isLooping = true;
      replayIndex = loggedData.length - 1; // ì¬ìƒ ì¬ì‹œì‘ ì‹œ ì—­ë°©í–¥ìœ¼ë¡œ
      isForward = false; // ì—­ë°©í–¥ìœ¼ë¡œ ì‹œì‘
      console.log('â–¶ï¸ ë°˜ë³µ ì¬ìƒ ì¬ì‹œì‘ (ì—­ë°©í–¥ ì‹œì‘)');
      updateStatus('â–¶ï¸ ì—­ë°©í–¥/ìˆœë°©í–¥ ë°˜ë³µ ì¤‘... | ì¡°ì´ìŠ¤í‹± ì…ë ¥ ì¤‘ì§€', 'text-green-600');
      loopReplay();
    } else {
      console.log('âš ï¸ ì¬ìƒí•  ë¡œê·¸ê°€ ì—†ê±°ë‚˜ ì´ë¯¸ ì¬ìƒ ì¤‘ì…ë‹ˆë‹¤.');
      updateStatus('ğŸš« ì¬ìƒí•  ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.', 'text-red-600');
    }
  });

  document.getElementById('resetLogButton').addEventListener('click', () => {
    isLogging = false;
    isReplaying = false;
    isLooping = false;
    loggedData = [];
    clearTimeout(replayTimeout);
    document.getElementById('startLogButton').textContent = "ë¡œê·¸ ì‹œì‘";
    updateStatus('ğŸ§¹ ì´ˆê¸°í™” ì™„ë£Œ!', 'text-red-600');
    console.log('ì´ˆê¸°í™” ì™„ë£Œ');
  });

  function loopReplay() {
    // ì¬ìƒ ì¡°ê±´ í™•ì¸
    if (!peer || !peer.connected || !isReplaying || !isLooping || loggedData.length === 0) {
      console.log('ì¬ìƒ ì¤‘ë‹¨: ì—°ê²° ëŠê¹€ ë˜ëŠ” ë¡œê·¸ ì—†ìŒ');
      isReplaying = false;
      isLooping = false;
      updateStatus('ì¬ìƒ ì¤‘ë‹¨ë¨', 'text-yellow-600');
      return;
    }

    // ì¸ë±ìŠ¤ ìœ íš¨ì„± ê²€ì‚¬
    if (replayIndex < 0 || replayIndex >= loggedData.length || !loggedData[replayIndex]) {
      console.error('ì˜ëª»ëœ ì¸ë±ìŠ¤:', replayIndex, 'ë°ì´í„° ê¸¸ì´:', loggedData.length);
      isReplaying = false;
      isLooping = false;
      updateStatus('ì¬ìƒ ì˜¤ë¥˜: ì˜ëª»ëœ ë°ì´í„°', 'text-red-600');
      return;
    }

    let data = loggedData[replayIndex];
    let sendData = { ...data };

    // ë°ì´í„° êµ¬ì¡° ê²€ì¦
    if (!data.axes || !data.buttons) {
      console.warn('ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„°:', data);
      replayIndex = isForward ? replayIndex + 1 : replayIndex - 1;
      replayTimeout = setTimeout(loopReplay, 16);
      return;
    }

    // ì—­ë°©í–¥ ì²˜ë¦¬: axes ê°’ ë°˜ì „
    if (!isForward) {
      sendData = {
        ...data,
        axes: data.axes.map(v => Number((-v).toFixed(2)))
      };
    }

    // ë°ì´í„° ì „ì†¡
    const payload = {
      axes: sendData.axes,
      buttons: sendData.buttons
    };
    try {
      peer.send(JSON.stringify(payload));
      console.log(`${isForward ? 'â–¶ï¸ ìˆœë°©í–¥' : 'â—€ï¸ ì—­ë°©í–¥'} [ì¸ë±ìŠ¤ ${replayIndex}/${loggedData.length - 1}] ì „ì†¡:`, JSON.stringify(payload));
      updateDataUI(sendData);
    } catch (error) {
      console.error('ë°ì´í„° ì „ì†¡ ì˜¤ë¥˜:', error);
    }

    // ë²„íŠ¼ ìƒíƒœ ë³€ê²½ ê°ì§€ ë° ì¶”ê°€ ì§€ì—°
    let extraDelay = 0;
    const prevIndex = isForward ? replayIndex - 1 : replayIndex + 1;
    if (prevIndex >= 0 && prevIndex < loggedData.length && loggedData[prevIndex]) {
      const prevData = loggedData[prevIndex];
      if (prevData.buttons && (prevData.buttons[4] !== sendData.buttons[4] || prevData.buttons[5] !== sendData.buttons[5])) {
        extraDelay = 50; // ë²„íŠ¼ ìƒíƒœ ë³€ê²½ ì‹œ 50ms ì¶”ê°€ ì§€ì—°
        console.log(`ë²„íŠ¼ ìƒíƒœ ë³€ê²½ ê°ì§€ (LB=${sendData.buttons[4]}, RB=${sendData.buttons[5]}), ì¶”ê°€ ì§€ì—° ${extraDelay}ms`);
      }
    }

    // íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë°˜ ë”œë ˆì´ ê³„ì‚°
    let delay = 16;
    const currentIndex = isForward ? replayIndex - 1 : replayIndex + 1;
    if (currentIndex >= 0 && currentIndex < loggedData.length && loggedData[currentIndex] && loggedData[replayIndex].timestamp) {
      const currentTimestamp = loggedData[currentIndex].timestamp;
      const nextTimestamp = loggedData[replayIndex].timestamp;
      if (currentTimestamp && nextTimestamp) {
        delay = Math.max(16, Math.abs(nextTimestamp - currentTimestamp));
      }
    }
    delay += extraDelay;

    // ì¸ë±ìŠ¤ ë° ë°©í–¥ ì—…ë°ì´íŠ¸
    if (isForward) {
      if (replayIndex < loggedData.length - 1) {
        replayIndex++;
      } else {
        isForward = false;
        replayIndex = loggedData.length - 1; // ì—­ë°©í–¥ìœ¼ë¡œ ì „í™˜
        console.log('ìˆœë°©í–¥ ë, ì—­ë°©í–¥ ì‹œì‘');
      }
    } else {
      if (replayIndex > 0) {
        replayIndex--;
      } else {
        isForward = true;
        replayIndex = 0; // ìˆœë°©í–¥ìœ¼ë¡œ ì „í™˜
        console.log('ì—­ë°©í–¥ ë, ìˆœë°©í–¥ ì‹œì‘');
      }
    }

    // ë‹¤ìŒ ì¬ìƒ ì˜ˆì•½
    replayTimeout = setTimeout(loopReplay, delay);
  }

  function updateGamepad() {
    const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
    if (gamepads[0]) {
      const gp = gamepads[0];
      const data = {
        axes: gp.axes.map(v => Number(v.toFixed(2))),
        buttons: gp.buttons.map(b => Number(b.pressed ? 1 : 0)),
        timestamp: Date.now()
      };

      if (!isReplaying) {
        updateDataUI(data);
        if (peer && peer.connected) {
          const payload = {
            axes: data.axes,
            buttons: data.buttons
          };
          try {
            peer.send(JSON.stringify(payload));
            console.log('ğŸ“¤ ì‹¤ì‹œê°„ ì „ì†¡:', JSON.stringify(payload));
          } catch (error) {
            console.error('ì‹¤ì‹œê°„ ì „ì†¡ ì˜¤ë¥˜:', error);
          }
        }
      }

      if (isLogging) {
        if (loggedData.length > 0) {
          const lastData = loggedData[loggedData.length - 1];
          if (lastData.buttons[4] !== data.buttons[4] || lastData.buttons[5] !== data.buttons[5]) {
            console.log(`ğŸ“ ë²„íŠ¼ ìƒíƒœ ë³€ê²½ ê¸°ë¡: LB=${data.buttons[4]}, RB=${data.buttons[5]}`);
          }
        }
        loggedData.push(data);
      }
    }
    requestAnimationFrame(updateGamepad);
  }

  window.addEventListener("gamepadconnected", (e) => {
    console.log("ğŸ® ì¡°ì´ìŠ¤í‹± ì—°ê²°ë¨:", e.gamepad);
    updateGamepad();
  });

  document.getElementById('disconnectButton').addEventListener('click', () => {
    socket.emit('disconnectSignal', { from: 'PC1' });
    if (peer && !peer.destroyed) peer.destroy();
    updateStatus('ì—°ê²° ëŠì–´ì§', 'text-red-600');
  });

  document.getElementById('reconnectButton').addEventListener('click', () => {
    isReconnecting = true;
    updateStatus('ì—°ê²° ëŒ€ê¸°ì¤‘...', 'text-yellow-600');
    clearTimeout(replayTimeout);
    loggedData = [];
    isReplaying = false;
    isLooping = false;
    document.getElementById('startLogButton').textContent = "ë¡œê·¸ ì‹œì‘";
    initializePeer();
    socket.emit('reconnectRequest', { from: 'PC1' });
  });

  document.getElementById('updateSize').addEventListener('click', () => {
    const w = document.getElementById('videoWidth').value;
    const h = document.getElementById('videoHeight').value;
    const v = document.getElementById('remoteVideo');
    v.style.width = w + 'px';
    v.style.height = h + 'px';
  });

  document.getElementById('fullscreenButton').addEventListener('click', () => {
    const video = document.getElementById('remoteVideo');
    if (video.requestFullscreen) {
      video.requestFullscreen();
    } else if (video.webkitRequestFullscreen) {
      video.webkitRequestFullscreen();
    } else if (video.msRequestFullscreen) {
      video.msRequestFullscreen();
    }
  });

  document.getElementById('sendButton').addEventListener('click', () => {
    const input = document.getElementById('messageInput');
    const msg = input.value.trim();
    if (!msg) return;

    if (peer && peer.connected) {
      peer.send(JSON.stringify({ type: 'chat', message: msg }));
      const chatBox = document.getElementById('chatBox');
      chatBox.innerHTML += `<div class="text-right text-blue-600">ğŸ“¤ ë‚˜: ${msg}</div>`;
      chatBox.scrollTop = chatBox.scrollHeight;
      input.value = '';
    } else {
      alert("ìƒëŒ€ë°©ê³¼ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    }
  });

  document.getElementById('messageInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('sendButton').click();
    }
  });

  document.getElementById('clearChatButton').addEventListener('click', () => {
    const confirmClear = confirm("ëŒ€í™”ì°½ì„ ëª¨ë‘ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?");
    if (confirmClear) {
      const chatBox = document.getElementById('chatBox');
      chatBox.innerHTML = '';
      document.getElementById('fileInput').value = ''; // íŒŒì¼ ì…ë ¥ì°½ë„ ì´ˆê¸°í™”
    }
  });


  document.getElementById('fileInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (file.size > 100 * 1024) {
      alert("ì „ì†¡ ë¶ˆê°€! 100KB ì´í•˜ì˜ íŒŒì¼ë§Œ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      return;
    }

    const reader = new FileReader();
    reader.onload = () => {
      if (peer && peer.connected) {
        peer.send(JSON.stringify({
          type: 'file',
          filename: file.name,
          data: reader.result
        }));
        const chatBox = document.getElementById('chatBox');
        chatBox.innerHTML += `<div class="text-right text-blue-600">ğŸ“¤ íŒŒì¼ ì „ì†¡: ${file.name}</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
        // íŒŒì¼ ì„ íƒì°½ ì´ˆê¸°í™”
        document.getElementById('fileInput').value = '';
      }
    };
    reader.readAsDataURL(file);
  });

  initializePeer();
</script>
</body>
</html>